# MySQL miscellaneous notes

## Get sizes of DB tables

	SELECT table_name AS "Tables", 
	round(((data_length + index_length) / 1024 / 1024), 2) "Size in MB" 
	FROM information_schema.TABLES 
	WHERE table_schema = "mt"
	ORDER BY (data_length + index_length) DESC;

## Maintain Movable Type activity log

    SELECT log_message, count(*) as cnt FROM mt_log GROUP BY log_message ORDER BY cnt DESC LIMIT 10;
    DELETE FROM mt_log WHERE log_message REGEXP 'Background Publishing Done|Synchrnizing Files Done|^Search|System Email Address|Scheduled Tasks Update';

Sample output:

	mysql> DELETE FROM mt_log WHERE log_message REGEXP 'Background Publishing Done|Synchrnizing Files Done|^Search|System Email Address';
	Query OK, 2829026 rows affected (7 min 7.53 sec)

## Connect over SSH tunnel

    cd /var/www/cgi-bin/mt
    ssh -N -L 3307:`grep -oP '(?<=DB_HOST ).*' mt-config.cgi`:3306 TUNNEL_HOST &
    mysqldump -P3307 -h127.0.0.1                      \
      --default-character-set=utf8 -a                 \
      -u`grep -oP '(?<=DBUser ).*'     mt-config.cgi` \
      -p`grep -oP '(?<=DBPassword ).*' mt-config.cgi` \
        `grep -oP '(?<=Database ).*'   mt-config.cgi` \
      | gzip -c | cat                                 \
      > ../mt-$(date +%Y-%m-%d-%H.%M.%S).sql.gz;
    fg
    # (CTRL+c) 

	mysqldump                                         \
	  --default-character-set=utf8 -a                 \
	  -h`grep -oP '(?<=DBHost ).*'     mt-config.cgi` \
	  -u`grep -oP '(?<=DBUser ).*'     mt-config.cgi` \
	  -p`grep -oP '(?<=DBPassword ).*' mt-config.cgi` \
	    `grep -oP '(?<=Database ).*'   mt-config.cgi` \
	  | gzip -c | cat                                 \
	  > ../mt-autobackup-$(date +%Y-%m-%d-%H.%M.%S).sql.gz;
	
	mysql --default-character-set=utf8                \
	  -h`grep -oP '(?<=DBHost ).*'     mt-config.cgi` \
	  -u`grep -oP '(?<=DBUser ).*'     mt-config.cgi` \
	  -p`grep -oP '(?<=DBPassword ).*' mt-config.cgi` \
	    `grep -oP '(?<=Database ).*'   mt-config.cgi` \
	  | gzip -c | cat                                 \
	  > ../mt-autobackup-$(date +%Y-%m-%d-%H.%M.%S).sql.gz;

## Misc

    --skip-extended-insert

GTID error:
    
    mysqldump --default-character-set=utf8 --set-gtid-purged=OFF -a -hDB_HOST -uDB_USER -p DB_NAME > DB_NAME-$(date +%Y-%m-%d-%H.%M.%S).sql

## Backup database

    mysqldump --default-character-set=utf8 -a -hDB_HOST -uDB_USER -p DB_NAME > DB_NAME-20130805.sql
    DB_PASS

## Drop, create and restore database:

    mysql --default-character-set=utf8 -hDB_HOST -uDB_USER -p -e "DROP DATABASE DB_NAME; CREATE DATABASE DB_NAME CHARACTER SET utf8 COLLATE utf8_general_ci;"; mysql --default-character-set=utf8 -hDB_HOST -uDB_USER -p DB_NAME < DB_NAME-20130809.sql
    DB_PASS

## Drop, create and restore database:

    mysql --default-character-set=latin1 -uDB_USER -p -e "DROP DATABASE DB_NAME; CREATE DATABASE DB_NAME CHARACTER SET latin1;"; mysql --default-character-set=latin1 -uDB_USER -p DB_NAME < DB_NAME-20130809.sql

## Create a new user `myuser` who can login from `localhost` with password `xxxx`

    mysql> create user 'myuser'@'localhost' identified by 'xxxx';
    mysql> create DATABASE DB_NAME CHARACTER SET utf8 COLLATE utf8_general_ci;
    mysql> grant all on myuser.* to 'myuser'@'localhost';
    
## Query all users and passwords

    mysql> select host, user, password from mysql.user;

## General CSV

http://stackoverflow.com/questions/15699301/export-mysql-data-to-excel-in-php#comment22294713_15700286
One more thing even CSV solution is ok, There are no need to use PHP for generate a csv from mysql table. It can be generated by sql statement `SELECT a,b,a+b INTO OUTFILE '/tmp/result.txt' FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n' FROM test_table;`

## Misc

mysql --default-character-set=utf8 -uDB_USER -p -e "DROP DATABASE DB_NAME; CREATE DATABASE DB_NAME CHARACTER SET utf8 COLLATE utf8_general_ci;";
mysql --default-character-set=utf8 -uDB_USER -p DB_NAME < mt.sql
